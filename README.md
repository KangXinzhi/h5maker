# ä»¿[æœ‰èµ](https://account.youzan.com/)åº—é“ºçš„ä½ä»£ç å¹³å°å¼€å‘

## å‰è¨€
å‰ä¸€æ®µæ—¶é—´ä¸€ç›´å¯¹ä½ä»£ç å¹³å°æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œåœ¨æ˜é‡‘ä¸Šä¹Ÿçœ‹åˆ°äº†å¾ˆå¤šä¼˜ç§€çš„ä½ä»£ç å¹³å°æ–‡ç« åˆ†äº«ï¼Œè‡ªå·±å°è¯•ä»¿[æœ‰èµ](https://www.youzan.com/v4/shop/setting/shop-info#/)çš„ä½ä»£ç å¹³å°å¼€å‘äº†æ­¤é¡¹ç›®ï¼Œå®ç°äº†ä½ä»£ç å¹³å°çš„åŸºæœ¬åŠŸèƒ½ã€‚  
å…ˆæ¥çœ‹ä¸‹æˆ‘ä»¬çš„è®¾è®¡ç¨¿**æœ‰èµ**é¡µé¢ï¼š  
![åŠ¨ç”»3.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09fd5411f03d4c85afc2b08a0f462189~tplv-k3u1fbpfcp-watermark.image?)
é¡¹ç›®æœ€ç»ˆå®ç°æ•ˆæœï¼š
![åŠ¨ç”»6.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99aa2cd23d4a4bc8bf071c929401ba9d~tplv-k3u1fbpfcp-watermark.image?)
## ä¸€. é¡¹ç›®è®¾è®¡
### 1.1 å¸ƒå±€
- åº—é“ºåˆ—è¡¨é¡µå¸ƒå±€ï¼š
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88a7cb6682e2437e90b262828e9361b5~tplv-k3u1fbpfcp-watermark.image?)

- ç”Ÿæˆå™¨é¡µé¢å¸ƒå±€ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2e0f088f25e41678e564f7107dbb401~tplv-k3u1fbpfcp-watermark.image?)

### 1.2 åŠŸèƒ½
- ä»ç»„ä»¶åŒºæ‹–æ‹½ç»„ä»¶ï¼Œæ‹–æ‹½åˆ°é¢„è§ˆåŒºåŸŸï¼Œ
- é€‰ä¸­é¢„è§ˆåŒºåŸŸçš„ç»„ä»¶å¯ä»¥åœ¨é…ç½®åŒºè¿›è¡Œæ ·å¼é…ç½®
- é¢„è§ˆåŒºåŸŸçš„ç»„ä»¶å¯ä»¥è¿›è¡Œæ‹–æ‹½æ’åº
- ç‚¹å‡»å¤´éƒ¨é¢„è§ˆæŒ‰é’®å¯ä»¥è¿›è¡Œé¢„è§ˆ
- ä¿å­˜æŒ‰é’®ä¿å­˜æ•°æ®
- é¢„è§ˆæŒ‰é’®é¢„è§ˆåº—é“º

### 1.3 é¡¹ç›®è®¾è®¡
- å‚è€ƒæœ‰èµé¢„è§ˆåŒºè®¾è®¡ï¼Œå‘ç°å…¶å†…éƒ¨ä½¿ç”¨çš„æ˜¯iframeï¼Œé¢„è§ˆåŒºè®¾è®¡æˆå•ç‹¬çš„iframeçš„æ–¹å¼æ˜¾ç¤ºï¼Œè¿™æ ·çš„å¥½å¤„ï¼šæ–¹ä¾¿é¢„è§ˆ,èŠ‚çœä»£ç ï¼Œä¸ç„¶è¦å®ç°ä¸¤è¾¹å±•ç¤ºåŒºçš„é€»è¾‘
- é¡¹ç›®åˆ†ä¸ºä¸¤ä¸ªç³»ç»Ÿï¼Œé¢„è§ˆåŒºiframeç³»ç»Ÿå’Œç¼–è¾‘å™¨ç³»ç»Ÿ
- æ•°æ®åº“é‡‡ç”¨æµè§ˆå™¨çš„indexDBï¼Œé…å¥—çš„ä¸‰æ–¹åº“é‡‡ç”¨[Dexie](https://dexie.org/)
- é¡¹ç›®éš¾ç‚¹ï¼šè·¨ iframe æ‹–æ‹½ï¼Œä¸€äº›æ‹–æ‹½ç»„ä»¶å¦‚react-dnd react-beautiful-dnd éƒ½æ— æ³•å®ç°ï¼Œå‚è€ƒäº†æ˜é‡‘ä¸Šçš„ä¸€äº›æ–‡ç« ï¼Œè½¬è½¬å›¢é˜Ÿå®ƒä»¬å› react-dndä¸æ”¯æŒè·¨iframeä¾¿æ”¾å¼ƒäº†ï¼Œè‡ªå·±ä½¿ç”¨åŸç”ŸH5çš„æ‹–æ‹½äº‹ä»¶å°è£…ä¸€ä¸ªã€‚æˆ‘çš„è®¾è®¡æ€è·¯ï¼šæ•°æ®é©±åŠ¨è§†å›¾ï¼Œå¯ä»¥åœ¨æ‹–åŠ¨æ—¶æ˜¾ç¤ºä¸€ä¸ªå’Œiframeæ ·å¼ç›¸åŒçš„ç›’å­ï¼Œæ¥æ¨¡æ‹Ÿiframeè¿›è¡Œæ‹–æ‹½ï¼Œå› ä¸ºåœ¨åŒä¸€ç»„ä»¶ä¸­å¹¶æœªè®¾è®¡åˆ°è·¨iframeå¹¶ä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•æ–¹å¼å®Œæˆå¦‚react-dndï¼Œåªéœ€æ‹–æ‹½ç»“æŸååŒæ­¥æ•°æ®ï¼Œä¼ ç»™iframeï¼Œiframeæ¥æ”¶åˆ°æ•°æ®åè¿›è¡Œæ˜¾ç¤º
- è·¨ Iframe é€šä¿¡ï¼Œé‡‡ç”¨ postMessage é€šä¿¡
### 1.4 ç»„ä»¶åŒºschemaå®šä¹‰
```
// ç±»å‹å®šä¹‰
{
  text: string  // ç»„ä»¶åŒºä¸­ç»„ä»¶çš„åç§°
  name: string  // ç»„ä»¶åŒºä¸­ç»„ä»¶çš„çš„key
  icon: string  // ç»„ä»¶åŒºä¸­ç»„ä»¶çš„iconåœ°å€
  config: {
    label: string   // é…ç½®åŒºä¸­titleåç§°
    type: string  // é…ç½®åŒºç»„ä»¶ç±»å‹
    format: string  
    value?: string
    config?: {  // é»˜è®¤é…ç½®é¡¹
      icon: string
      style: React.CSSProperties
      tooltip: string,
    }
    configOptions?: {  // é…ç½®åŒºä¸­ç»„ä»¶é…ç½®åˆ—è¡¨
      icon: string
      style: React.CSSProperties
      tooltip: string,
    }[]
  }[]
}

// å®é™…åº”ç”¨(æ ‡é¢˜)
{
    text: 'æ ‡é¢˜æ–‡æœ¬',
    name: "titleText",
    icon: 'https://img01.yzcdn.cn/upload_files/2022/06/17/FjAs6eTmbK_4lQRI3GYXu97Fj_B_.png',
    config: [
      {
        label: "æ ‡é¢˜å†…å®¹",
        type: "input",
        format: "title",
        value: 'è¯·è¾“å…¥æ–‡æœ¬å†…å®¹'
      },
      {
        label: "æ˜¾ç¤ºä½ç½®",
        type: "legend-style-line",
        format: "position",
        config: {
          icon: '#icon-alignleft',
          style: {
            justifyContent: 'left',
          },
          tooltip: 'å±…å·¦æ˜¾ç¤º',
        },
        configOptions: [
          {
            icon: '#icon-alignleft',
            style: {
              justifyContent: 'left',
            },
            tooltip: 'å±…å·¦æ˜¾ç¤º',
          },
          {
            icon: '#icon-aligncenter',
            style: {
              justifyContent: 'center',
            },
            tooltip: 'å±…ä¸­æ˜¾ç¤º',
          }
        ]
      },
    ],
  }
```

### 1.5 æ•°æ®åº“è®¾è®¡

æ•°æ®åº“ï¼šmyDatabase
è¡¨ï¼šShopList
å±æ€§ï¼š
|  id   | title  | state  | createTime  | memo  | schema  |
|  ----  | ----  | ----  | ----  | ----  | ----  |
| è‡ªå¢  | æ ‡é¢˜ | çŠ¶æ€ | åˆ›å»ºæ—¶é—´ | å¤‡æ³¨ | schema |


å¯¹åº”çš„ db.jsæ–‡ä»¶
```
import Dexie from 'dexie';

export const db: any = new Dexie('myDatabase');
db.version(1).stores({
  ShopList: '++id, title, state, createTime, memo, schema',
});
```

## äºŒ. å¼€å‘åˆæ¢
### 2.1 åˆ›å»ºé¡¹ç›®
é¡¹ç›®åˆ†ä¸ºä¸¤ä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥åœ¨packagesåˆ›å»ºä¸¤ä¸ªé¡¹ç›®  
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a54585874c804f01b2215dbea740a913~tplv-k3u1fbpfcp-watermark.image?)  

- H5makeé¡¹ç›®ä¸ºä¸»é¡¹ç›®ï¼ˆç«¯å£3000ï¼‰ï¼Œæœ‰ä¸¤ä¸ªé¡µé¢ï¼Œåˆ—è¡¨é¡µé¢å’Œç”Ÿæˆå™¨é¡µé¢   
- previewæ˜¯é¢„è§ˆé¡¹ç›®ï¼ˆç«¯å£3007ï¼‰ï¼Œä½¿ç”¨ifrmaeçš„æ–¹å¼åµŒå¥—åˆ°H5makerä¸­
- ç›´æ¥ç”¨yarn create vite ç”Ÿæˆreacté¡¹ç›®


### 2.2 åˆ—è¡¨é¡µå¼€å‘å’Œæ•°æ®åº“é…ç½®
headeråŒºæœ‰ä¸€ä¸ªæ–°å»ºæŒ‰é’®ï¼Œå†…å®¹åŒºä¸€ä¸ªtableè¡¨æ ¼ï¼Œç›´æ¥ä½¿ç”¨antdç»„ä»¶åº“æ¥ç»˜åˆ¶åŸºæœ¬é¡µé¢     
æ•°æ®æºæ¥è‡ªæµè§ˆå™¨è‡ªå¸¦çš„indexDBæ•°æ®åº“  
æ•°æ®åº“é‡‡ç”¨æµè§ˆå™¨çš„indexDBï¼Œé…å¥—çš„ä¸‰æ–¹åº“é‡‡ç”¨[Dexie](https://dexie.org/)    
ç”Ÿæˆdb.jsæ–‡ä»¶
```
import Dexie from 'dexie';

export const db: any = new Dexie('myDatabase');
db.version(1).stores({
  ShopList: '++id, title, state, createTime, memo, schema',
});
```
ç›´æ¥å¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨useLiveQueryè¯·æ±‚indexDBæ•°æ®åº“ä¸­çš„æ•°æ®
```
import { useLiveQuery } from 'dexie-react-hooks';
import { db } from '../../db';

const shopList = useLiveQuery(
  () => db.ShopList?.toArray()
);
```
ä½¿ç”¨å‘æ•°æ®åº“ä¸­æ·»åŠ æ•°æ®
```
import { db } from '../../db';

await db.ShopList?.put({
  title: 'æœªå‘½å',
  state: 'normal',
  createTime: new Date(),
  memo: '',
  schema: [],
});
```

æœ€ç»ˆç”Ÿæˆçš„pagesä¸‹çš„listæ–‡ä»¶ï¼š
```
import React from 'react';
import { Table, Space, Button } from 'antd';
import type { ColumnsType } from 'antd/lib/table';
import { useLiveQuery } from 'dexie-react-hooks';
import { useNavigate } from 'react-router-dom'
import dayjs from 'dayjs'
import { db } from '../../db';
import './index.less'

interface DataType {
  id: number;
  title: string;
  state: string;
  createTime: Date;
  memo: string;
}

const List: React.FC = () => {
  let navigate = useNavigate();
  const columns: ColumnsType<DataType> = [
    {
      title: 'åç§°',
      dataIndex: 'title',
      render: text => <a>{text}</a>,
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'state',
      render: text => <span>{text==='normal'&&'æ­£å¸¸'}</span>,
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createTime',
      render: (time) => {
        return dayjs(time).format('YYYY-MM-DD HH:mm:ss')
      }
    },
    {
      title: 'å¤‡æ³¨',
      dataIndex: 'memo',
    },
    {
      title: 'æ“ä½œ',
      dataIndex: 'memo',
      render: (_, record)=>{
        return (
          <>
            <Button 
              type='primary' 
              style={{marginRight:'12px'}}
              onClick={()=> {
                navigate(`/shop/edit/${record.id}`)
              }}
            >ç¼–è¾‘</Button>
            <Button>åˆ é™¤</Button>
          </>
        )
      }
    }
  ];

  const shopList = useLiveQuery(
    () => db.ShopList?.toArray()
  );

  const addShop = async () => {
    const id = await db.ShopList?.put({
      title: 'æœªå‘½å',
      state: 'normal',
      createTime: new Date(),
      memo: '',
      schema: [],
    });
    navigate(`/shop/edit/${id}`)
  }

  return (
    <div className='container'>
      <Button
        type="primary"
        style={{
          marginBottom: '16px'
        }}
        onClick={addShop}>
        æ–°å»º
      </Button>
      <Table bordered columns={columns} dataSource={shopList} />
    </div>
  )
}

export default List
```
æ•ˆæœé¢„è§ˆï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0faf5c1e8e29468eaaea87f9ab53d5fa~tplv-k3u1fbpfcp-watermark.image?)
å¯¹åº”çš„æ•°æ®åº“
![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/110ca0e65b1541b7b32229f9b35f370f~tplv-k3u1fbpfcp-watermark.image?)

## ä¸‰. ä½ä»£ç ç”Ÿæˆå™¨é¡µé¢å¼€å‘
å†æ¥çœ‹ä¸‹æˆ‘ä»¬çš„è®¾è®¡ç¨¿æœ‰èµé¡µé¢ï¼š
![åŠ¨ç”»3.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09fd5411f03d4c85afc2b08a0f462189~tplv-k3u1fbpfcp-watermark.image?)
æ€è·¯åˆ†æï¼š  
ç»„ä»¶é¢„è§ˆåŒºæ˜¾ç¤ºçš„æ˜¯iframeç›’å­ï¼š
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99dc59d38abb48f18c34966d7b1625cc~tplv-k3u1fbpfcp-watermark.image?)
å› ä¸ºè·¨iframeæ‹–æ‹½å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œä¸€äº›æ‹–æ‹½åº“éƒ½ä¸æ”¯æŒè·¨iframeæ‹–æ‹½ï¼Œæ¯”å¦‚react-dnd  
è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå½“ç»„ä»¶æ‹–åŠ¨æ—¶ï¼Œå¤§å°ä½ç½®ä¸€æ¨¡ä¸€æ ·çš„å‡iframeç›’å­å‡ºç°ï¼ŒçœŸiframeéšè—ï¼Œä»è·¨é¡µé¢æ‹–æ‹½è½¬ç§»åˆ°åœ¨ä¸€ä¸ªé¡µé¢è¿›è¡Œæ‹–æ‹½ï¼Œ  
æ•°æ®é©±åŠ¨è§†å›¾ï¼Œæ‹–æ‹½å®Œæˆåå’Œiframeé¡µé¢åŒæ­¥ä¸‹æ•°æ®ï¼Œè§£å†³react-dndæ— æ³•å®ç°è·¨iframeæ‹–æ‹½çš„é—®é¢˜ã€‚
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9bc92b9cd1a64f1b87c4ab9803390044~tplv-k3u1fbpfcp-watermark.image?)

ä½ä»£ç ç”Ÿæˆå™¨é¡µé¢å¼€å‘æµç¨‹ï¼š
- æ ¹é¡µé¢ç»´æŠ¤ä¸€ä¸ªcardså…¨å±€æ•°æ®ï¼Œå­˜æ”¾é¢„è§ˆåŒºåŸŸçš„æ•°æ®
- è¿›å…¥ç¼–è¾‘é¡µé¢ä»æ•°æ®åº“ä¸­è¯»å–cardsæ•°æ®ï¼Œè·å–æ•°æ®åç”¨postMessageåŒæ­¥**ä¸¤ç«¯**æ•°æ®ï¼ˆiframeç«¯ã€ä½ä»£ç ç”Ÿæˆå™¨ç«¯ï¼‰æ•°æ®
- å·¦ä¾§ç»„ä»¶åŒºï¼š
    - æ¯ä¸ªç»„ä»¶æœ‰è‡ªå·±çš„schemaå®šä¹‰è§„åˆ™ï¼Œæ ¹æ®schemaå¯ä»¥åœ¨é¢„è§ˆåŒºé¢„è§ˆï¼Œç¼–è¾‘åŒºæ˜¾ç¤ºå¹¶ç¼–è¾‘
    - æ¯ä¸ªç»„ä»¶å¯ä»¥æ‹–æ‹½ï¼Œç”¨react-dndç»„ä»¶åº“å®ç°æ‹–æ‹½ï¼Œæ‹–æ‹½æ—¶ï¼Œéšè—iframeï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿiframeçš„å‡ç›’å­ï¼Œå› ä¸ºå‡ç›’å­å’Œç»„ä»¶æ˜¯åŒä¸€ä¸ªiframeçš„æ•°æ®ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œæ‹–æ‹½
    - æ‹–æ‹½ç»“æŸåï¼ŒpostMessageåŒæ­¥**ä¸¤ç«¯**æ•°æ®ï¼Œéšè—iframeå‡ç›’å­ï¼Œæ˜¾ç¤ºiframe
- iframeé¢„è§ˆåŒºï¼š
    - ä¸€ä¸ªiframeé¡µé¢ï¼Œä¸€ä¸ªå¸ƒå±€å’Œiframeé¡µé¢å®Œå…¨ç›¸åŒçš„å‡ç›’å­
    - åœ¨iframeä¸­ï¼Œå¯ä»¥è¿›è¡Œæ‹–æ‹½æ’åºï¼Œæ‹–æ‹½æ’åºå®Œæˆåï¼Œä½¿ç”¨postMessageåŒæ­¥**ä¸¤ç«¯**æ•°æ®
- ç»„ä»¶é…ç½®åŒºï¼šé¢„è§ˆåŒºç‚¹å‡»é€‰ä¸­æŸä¸€ä¸ªç»„ä»¶æ—¶ï¼Œé¢„è§ˆåŒºæ ¹æ®schemaæ˜¾ç¤ºå®ƒçš„å¯é…ç½®é¡¹ï¼Œåœ¨é¢„è§ˆåŒºè¿›è¡Œé…ç½®ï¼Œæ•ˆæœæ˜¾ç¤ºåœ¨é¢„è§ˆåŒº
- ä¿å­˜æŒ‰é’®ï¼Œå°†å½“å‰çš„cardsæ•°æ®ï¼Œå­˜å…¥æ•°æ®åº“

### 3.1 postMessage åŒæ­¥ä¸¤ç«¯æ•°æ®
- è¿›å…¥ç¼–è¾‘é¡µé¢æ—¶ï¼Œåœ¨ä½ä»£ç ç«¯å‘æ•°æ®åº“è¯·æ±‚æ•°æ®ï¼Œè¯·æ±‚åˆ°æ•°æ®ååŒæ­¥ä¸¤ç«¯æ•°æ®ï¼Œä»ä½ä»£ç ç«¯å‘é€åˆ°Iframeç«¯
```
  // ä½ä»£ç ç«¯å‘é€
  const [cards, setCards] = useState([]); // all component
  const iFrame = document.getElementById('previewIframe') as HTMLIFrameElement;
  const shopSchema = useLiveQuery(
    () => db.ShopList?.get(shopId)
  );
  useEffect(() => {
    if (!shopSchema?.schema) return
    setCards(shopSchema.schema)

    // åˆå§‹åŒ–è·å–æ•°æ®åï¼Œå‘ preview åŒæ­¥ä¸€æ¬¡æ•°æ®
    if (iFrame && iFrame.contentWindow) {
      setTimeout(() => {
        iFrame.contentWindow!.postMessage(shopSchema?.schema, 'http://localhost:3007/#/preview');
      }, 1000)
    }
  }, [shopSchema])
```
```
  // iframeç«¯æ¥æ”¶
  const [cards, setCards] = useState([]); // all component

  //ç›‘å¬ä½ä»£ç ç”Ÿæˆå™¨ç«¯ ä¼ è¿‡æ¥çš„postmessage
  useEffect(() => {
    window.addEventListener('message', (e) => {
      if (e.origin === 'http://localhost:3000') {
        e.data && setCards(e.data)
      }
    });
  }, []);

```
---
- ä»ç»„ä»¶åŒºæ‹–æ‹½åˆ°é¢„è§ˆåŒºç»“æŸååŒæ­¥ä¸¤ç«¯æ•°æ®ï¼Œä»ä½ä»£ç ç«¯å‘é€åˆ°Iframeç«¯
```
  // ä½ä»£ç ç«¯å‘é€æ•°æ®
  useEffect(() => {
    if (iFrame && iFrame.contentWindow) {
      iFrame.contentWindow!.postMessage(cards, 'http://localhost:3007/#/preview');
    }
  }, [cards])
```
```
  // iframeç«¯æ¥æ”¶æ•°æ®(åŒä¸Š)
  const [cards, setCards] = useState([]); // all component

  //ç›‘å¬ä½ä»£ç ç”Ÿæˆå™¨ç«¯ ä¼ è¿‡æ¥çš„postmessage
  useEffect(() => {
    window.addEventListener('message', (e) => {
      if (e.origin === 'http://localhost:3000') {
        e.data && setCards(e.data)
      }
    });
  }, []);

```
---
- åœ¨iframeç«¯ä¸Šæ‹–æ‹½æ’åºï¼ŒåŒæ­¥ä¸¤ç«¯æ•°æ®ï¼Œä»Iframeç«¯å‘é€åˆ°ä½ä»£ç ç«¯
``` 
  // Iframeç«¯å‘é€æ•°æ®
  const [cards, setCards] = useState([]); // all component
  const [compActiveIndex, setCompActiveIndex] = useState<number | null>(null); // ç”»å¸ƒä¸­å½“å‰æ­£é€‰ä¸­çš„ç»„ä»¶

  // åˆå§‹åŒ–æ— éœ€åŒæ­¥ï¼Œå› æ­¤ä½¿ç”¨ahooksçš„useUpdateEffectæ–¹æ³•
  useUpdateEffect(() => {
    window.parent.postMessage({ compActiveIndex: compActiveIndex, cards: cards }, "*");
  }, [compActiveIndex])
```
```
  // ä½ä»£ç ç«¯æ¥æ”¶æ•°æ®
  useEffect(() => {
    window.addEventListener('message', ({ data }) => {
      const { compActiveIndex, cards } = data;
      setCompActiveIndex(compActiveIndex);
      setCards(cards);
    });
  }, []);
```
### 3.2 æ‹–æ‹½å®ç°
ç»„ä»¶åŒºçš„æ¯ä¸ªç»„ä»¶æ‹–æ‹½æ—¶ï¼Œé¢„è§ˆåŒºæ˜¾ç¤ºæ¨¡æ‹Ÿçš„iframeå‡ç›’å­ï¼Œæ‹–æ‹½ç»“æŸåï¼Œæ˜¾ç¤ºçœŸiframe
```
  // ç»„ä»¶åŒº
  const [{ isDragging }, drag] = useDrag(
    {
      item: { comp: item, originalIndex: -1 },
      type: 'comp',
      end: (item: any, monitor: DragSourceMonitor) => {
        setShowIframe(true)
        if (monitor.didDrop()) {
          item.originalIndex = -1
        }
      },
      collect: (monitor) => ({
        isDragging: monitor.isDragging(),
      }),
    },
    [],
  );

  useEffect(() => {
    if (isDragging) {
      setShowIframe(false)
    }
  }, [isDragging])
```
```
  // iframeåŒº
  <iframe
    id="previewIframe"
    src="http://localhost:3007/#/preview"
    style={{ visibility: showIframe ? 'visible' : 'hidden' }}
  />
  <div
    style={{ visibility: !showIframe ? 'visible' : 'hidden' }}
  >
    ...
    <Card />
  </div>
```
```
  // iframeåŒº
  <iframe
    id="previewIframe"
    src="http://localhost:3007/#/preview"
    style={{ visibility: showIframe ? 'visible' : 'hidden' }}
  />
  <div
    style={{ visibility: !showIframe ? 'visible' : 'hidden' }}
  >
    <DropCard/>
    ...
  </div>
  
  const DropCard = ()=>{
   ...
      // æ‹–æ‹½æ”¾ç½®åŒºï¼Œreact-dnd æ–¹æ³•
      const [{ handlerId }, drop] = useDrop<
        DragItem,
        void,
        { handlerId: Identifier | null }
      >({
        accept: 'comp',
        collect(monitor) {
          return {
            handlerId: monitor.getHandlerId(),
          }
        },
        hover(item: DragItem, monitor) {
          ...
          // åˆ¤æ–­æ‹–æ‹½ç»„ä»¶æ˜¯å¦æ—¶æ¥è‡ªç»„ä»¶åŒºï¼Œ-1æ˜¯æ¥è‡ªç»„ä»¶åŒºï¼Œè‹¥ä¸æ˜¯ç»„ä»¶åŒºï¼Œåˆ™æ˜¯ç»„ä»¶å†…éƒ¨çš„æ‹–æ‹½æ’åº
          if (item.originalIndex !== -1) {
            setCards((prevCards: IComponentItemProps[]) =>
              update(prevCards, {
                $splice: [
                  [dragIndex, 1],
                  [hoverIndex, 0, prevCards[dragIndex] as IComponentItemProps],
                ],
              }),
            )
          } else {
            setCards((prevCards: IComponentItemProps[]) =>
              update(prevCards, {
                $splice: [
                  [hoverIndex, 0, item.comp],
                ],
              }),
            )
          }
          item.originalIndex = hoverIndex
        },
      })
    // ç»„ä»¶å†…éƒ¨çš„æ‹–æ‹½æ’åº
    const [{ isDragging }, drag] = useDrag({
        type: 'comp',
        item: () => {
          return { comp: item, originalIndex: index }
        },
        isDragging: (monitor) => {
          return `card-${monitor.getItem().originalIndex}` === IDkey
        },
        collect: (monitor) => ({
          isDragging: monitor.isDragging(),
        }),
     })
  }  
```
å‘ç”Ÿåœ¨iframeä¸Šçš„æ‹–æ‹½ï¼Œæ‹–æ‹½æ–¹æ³•åŒä¸Šï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œæ‹–æ‹½ç»“æŸåï¼ŒåŒæ­¥ä¸¤ç«¯æ•°æ®æ˜¯ç”±iframeç«¯å‘é€åˆ°ä½ä»£ç ç«¯ã€‚

### 3.3 é…ç½®åŒºã€é¢„è§ˆåŒºé€‚é…schema
å†æ¥çœ‹ä¸‹å®é™…çš„schemaå®šä¹‰
```
 [
  {
    text: 'æ ‡é¢˜æ–‡æœ¬',
    name: "titleText",
    icon: 'https://img01.yzcdn.cn/upload_files/2022/06/17/FjAs6eTmbK_4lQRI3GYXu97Fj_B_.png',
    config: [
      {
        label: "æ ‡é¢˜å†…å®¹",
        type: "input",
        format: "title",
        value: 'è¯·è¾“å…¥æ–‡æœ¬å†…å®¹'
      },
      {
        label: "æè¿°å†…å®¹",
        type: "textarea",
        format: "content",
        value: 'è¯·è¾“å…¥æ ‡é¢˜å†…å®¹'
      },
      {
        label: "æ˜¾ç¤ºä½ç½®",
        type: "legend-style-line",
        format: "position",
        config: {
          icon: '#icon-alignleft',
          style: {
            justifyContent: 'left',
          },
          tooltip: 'å±…å·¦æ˜¾ç¤º',
        },
        configOptions: [
          {
            icon: '#icon-alignleft',
            style: {
              justifyContent: 'left',
            },
            tooltip: 'å±…å·¦æ˜¾ç¤º',
          },
          {
            icon: '#icon-aligncenter',
            style: {
              justifyContent: 'center',
            },
            tooltip: 'å±…ä¸­æ˜¾ç¤º',
          }
        ]
      },
      {
        label: "æ ‡é¢˜å¤§å°",
        type: "legend-style-line",
        format: "title-size",
        config: {
          icon: '#icon-alignleft',
          style: {
            fontSize: '16px',
          },
          tooltip: 'å¤§(16)å·',
        },
        configOptions: [
          {
            icon: '#icon-font-16',
            style: {
              fontSize: '16px',
            },
            tooltip: 'å¤§(16)å·',
          },
          {
            icon: '#icon-font-14',
            style: {
              fontSize: '14px',
            },
            tooltip: 'ä¸­(14)å·',
          },
          {
            icon: '#icon-font-12',
            style: {
              fontSize: '12px',
            },
            tooltip: 'å°(12)å·',
          }
        ]
      },
      {
        label: "æè¿°å¤§å°",
        type: "legend-style-line",
        format: "content-size",
        config: {
          icon: '#icon-font-12',
          style: {
            fontSize: '12px',
          },
          tooltip: 'å°(12)å·',
        },
        configOptions: [
          {
            icon: '#icon-font-16',
            style: {
              fontSize: '16px',
            },
            tooltip: 'å¤§(16)å·',
          },
          {
            icon: '#icon-font-14',
            style: {
              fontSize: '14px',
            },
            tooltip: 'ä¸­(14)å·',
          },
          {
            icon: '#icon-font-12',
            style: {
              fontSize: '12px',
            },
            tooltip: 'å°(12)å·',
          }
        ]
      },
    ],
  }
]
```

- é…ç½®åŒºé€‚é…schema
```
const index = (props: IProps) => {
  const { cards, setCards, compActiveIndex } = props

  return (
    <div className="editor">
      {compActiveIndex !== null && (
        <>
          <h2>{cards[compActiveIndex].text}</h2>
          {cards[compActiveIndex].config.map((item, index) => (
            item.type === 'input' && (
              <div className='item'>
                <h4>{item.label}</h4>
                <Input
                  placeholder='è¯·è¾“å…¥å†…å®¹'
                  value={cards[compActiveIndex].config[index].value}
                  onChange={(e) => {
                    const copyCards = cards.splice(0)
                    copyCards[compActiveIndex].config[index].value = e.target.value
                    setCards(copyCards)
                  }} />
              </div>
            ) ||
            item.type === 'textarea' && (
              <div className='item'>
                <h4>{item.label}</h4>
                <TextArea
                  placeholder='è¯·è¾“å…¥å†…å®¹'
                  value={cards[compActiveIndex].config[index].value}
                  onChange={(e) => {
                    const copyCards = cards.splice(0)
                    copyCards[compActiveIndex].config[index].value = e.target.value
                    setCards(copyCards)
                  }} />

              </div>
            ) ||
            item.type === 'legend-style-line' && (
              <div className='legend-line'>
                <div>
                  <span className='legend-line-title'>{item?.label || ''}</span>
                  <span className='legend-line-value'>{item?.config?.tooltip || ''}</span>
                </div>
                <div>
                  {
                    item?.configOptions?.length > 0 && (
                      item.configOptions.map((item2, index2) => (
                        <Button
                          key={`icon-${index}-${index2}`}
                          className={classNames({
                            'button-active': item?.config?.tooltip === item2.tooltip,
                          })}
                          onClick={() => {
                            const copyCards = cards.splice(0)
                            copyCards[compActiveIndex].config[index].config = item2
                            setCards(copyCards)
                          }}
                        >
                          <svg className="icon" aria-hidden="true">
                            <use xlinkHref={item2?.icon || ''}></use>
                          </svg>
                        </Button>
                      ))
                    )
                  }
                </div>
              </div>
            )
          ))}
        </>
      )}
    </div>
  )
}
```
é…ç½®åŒºé€‚é…schemaåæ•ˆæœï¼š
![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eaa360a37b5e49caaa79a50f6413f1e1~tplv-k3u1fbpfcp-watermark.image?)

- é¢„è§ˆåŒºé€‚é…schema
```
<div>
  {item.name === 'titleText' && item?.config.map((item2, index2) => {
        return (
          <div
            key={`titleText-${index2}`}
            className='title-text-container'
            style={titleTextStyle['position']}
          >
            {item2.type === 'input' && (<span className='titleTextBlonder' style={titleTextStyle['title-size']}>{item2.value}</span>)}
            {item2.type === 'textarea' && (<span style={titleTextStyle['content-size']}>{item2.value}</span>)}
          </div>
        )
      })}
</div>
```
é¢„è§ˆåŒºé€‚é…schemaåæ•ˆæœï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/424b6a75103d4f12b7ef206b03d670d9~tplv-k3u1fbpfcp-watermark.image?)

æ•´ä½“æ•ˆæœé¢„è§ˆï¼š

![åŠ¨ç”»3.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/027c49f69eb0490b9548bae3a058f76e~tplv-k3u1fbpfcp-watermark.image?)

åˆ°ç°åœ¨ä½ä»£ç åŸºæœ¬åŠŸèƒ½å·²ç»å®ç°äº†ï¼Œå¯ä»¥è¿›è¡Œæ‹–æ‹½ï¼Œä½ä»£ç åŒºåŸŸé…ç½®

## å››. é¡¹ç›®ä¼˜åŒ–
æ ¹æ®æœ‰èµå®˜æ–¹çš„'è®¾è®¡ç¨¿'ç»§ç»­å®Œå–„æˆ‘ä»¬çš„é¡¹ç›®
### 4.1 é¢„è§ˆåŒºé…ç½® header å’Œ footer
è¿™ä¸€éƒ¨åˆ†ä»£ç ä¸Šæ¯”è¾ƒç®€å•ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯éš¾ç‚¹ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥è´´ä¸Šæœ€ç»ˆæ•ˆæœå›¾

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a3ea4c23aef4c06b932bd1a682d6b02~tplv-k3u1fbpfcp-watermark.image?)
åœ¨è¿™æ ·çš„å†…éƒ¨è¿›è¡Œæ‹–æ‹½ï¼Œå°±å¾ˆèˆ’æœäº† ^ _ ^ æœ‰æ‰‹æœºåº—é“ºçš„æ„Ÿè§‰äº†ã€‚


### 4.2 é¢„è§ˆåŠŸèƒ½å¼€å‘
å› ä¸ºæˆ‘ä»¬çš„è®¾è®¡æ˜¯ç”¨iframeåµŒå¥—çš„ï¼Œè¿™æ ·çš„è®¾è®¡åœ¨å¼€å‘é¢„è§ˆåŠŸèƒ½æ—¶æ˜¯ç›¸å¯¹æ¯”è¾ƒæ–¹ä¾¿

å¼€å‘è®¾è®¡ï¼š
- åœ¨**é¢„è§ˆ**ç³»ç»Ÿä¸­ï¼Œæ–°å»ºä¸€ä¸ªä¸èƒ½æ‹–æ‹½ï¼Œç¼–è¾‘çš„iframeé¡µé¢
- åœ¨**ä½ä»£ç **ç³»ç»Ÿä¸­ï¼Œå½“ç‚¹å‡»é¢„è§ˆåŠŸèƒ½æ—¶ï¼Œè·³è½¬ä¸€ä¸ªé¢„è§ˆé¡µé¢ï¼ŒåµŒå…¥ä¸Šè¾¹çš„iframe

ä½ä»£ç ï¼š
![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/099c70600bac45d3b8b02db782a3ffd8~tplv-k3u1fbpfcp-watermark.image?)

é¢„è§ˆï¼š
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63767bdb0d1c477c9e5b41a99e309945~tplv-k3u1fbpfcp-watermark.image?)


### 4.3 åŒæ­¥ä¸¤ç«¯iframeè¢«å·èµ°çš„é¡µé¢æ•°æ®
é—®é¢˜ï¼šå½“åœ¨é¢„è§ˆåŒºåŸŸå†…å®¹è¿‡é•¿ï¼Œé¡µé¢å†…å®¹å‘ç”Ÿæ»šåŠ¨åï¼Œå½“è¿›è¡Œæ‹–æ‹½ï¼Œæ­¤æ—¶æ˜¾ç¤ºçš„å‡iframeçš„ç›’å­å¹¶æœªæ»šåŠ¨ï¼Œå‡iframeç›’å­å’ŒçœŸiframeç›’å­å‡ºç°æ˜¾ç¤ºå†…å®¹ä¸åŒçš„é—®é¢˜ã€‚  
çœŸiframeç›’å­ï¼š
![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ea0608613c54b3eb727222779866b6d~tplv-k3u1fbpfcp-watermark.image?)

æ‹–æ‹½æ—¶å‡iframeç›’å­ï¼š
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66c67c3f8e834bfbae0220097c07a299~tplv-k3u1fbpfcp-watermark.image?)

è§£å†³æ–¹æ¡ˆï¼š  
é¢„è§ˆç«¯çš„çœŸiframeç›’å­è¿›è¡Œæ»šåŠ¨æ—¶ï¼ŒåŒæ­¥æ»šåŠ¨çš„scrollTopå€¼ï¼Œå‘é€ç»™ä½ä»£ç ç«¯ï¼Œä½ä»£ç æ¥å—åˆ°ååŒæ­¥å‘ç”Ÿåç§»ã€‚
```
// é¢„è§ˆç«¯
  useEffect(() => {
    window.addEventListener('scroll', debounce(()=>{
      const scrollY = document.documentElement.scrollTop || document.body.scrollTop;
      window.parent.postMessage({ scrollY }, "*");
    }, 500))
  }, [])
```
```
// ä½ä»£ç ç«¯

const [scrollY, setScrollY] = useState(0)

 useEffect(() => {
    window.addEventListener('message', ({ data }) => {
      const { compActiveIndex, cards, scrollY } = data;
      compActiveIndex !== null && setCompActiveIndex(compActiveIndex);
      cards && setCards(cards);
      setScrollY(scrollY)
    });
  }, []);
  return (
     <div
        className='preview'
        style={{ 
          top: -(scrollY ?? 0) + 56 + 16 +'px'
        }}
      >
      ...
     </div>
   )
```

## é¡¹ç›®åœ°å€
é¡¹ç›®åœ°å€ï¼š  
https://github.com/KangXinzhi/h5maker  

åˆ›ä½œä¸æ˜“ï¼Œå¦‚æœ‰å¸®åŠ©ï¼Œæ„Ÿè°¢starğŸ™


å‚è€ƒï¼š   
https://juejin.cn/post/7015890033622646792
https://juejin.cn/post/6933385955789406222
